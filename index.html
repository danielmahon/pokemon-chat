<!DOCTYPE html>
<html>
<head>
	 <script type="text/javascript" src="http://code.jquery.com/jquery-1.4.2.js" ></script>
	 
	 <script type="text/javascript">
	 // ** Use this code to read the _GET variables from the URL
	 // ** All to be done before impact starts up.
	 
		  // Create a global array that will hold the value of each variable,
		  // keyed by the name of the variable.
		  var GETDATA = new Array();
		  
		  // Get the string that follows the "?" in the window's location.
		  var sGet = window.location.search;
		  if (sGet) // if has a value...
		  {
		      // Drop the leading "?"
		      sGet = sGet.substr(1);
		      
		      // Generate a string array of the name value pairs.
		      // Each array element will have the form "foo=bar"
		      var sNVPairs = sGet.split("&");
		      
		      // Now, for each name-value pair, we need to extract
		      // the name and value.
		      for (var i = 0; i < sNVPairs.length; i++)
		      {
			  // So, sNVPairs[i] contains the current element...
			  // Split it at the equals sign.
			  var sNV = sNVPairs[i].split("=");
			  
			  // Assign the pair to the GETDATA array.
			  var sName = sNV[0];
			  var sValue = sNV[1];
			  GETDATA[sName] = sValue;
		      }
		  }
	 
		  // username fetched from url
		  var username = "";
		  username += GETDATA.user;
		  if(username=="undefined") username = 'player' + Math.floor(Math.random()*999);
		  
		  var jsonPos = new Object();
		  $.ajax({
			   url : "login.php?do=readPosition&user=" + username,
			   success : function(result){
				    //alert(result);
				    jsonPos = jQuery.parseJSON(result); // returns JavaScript object
			   }
		  });
	 
	 // ** End login logic
	 </script>
	 
	 <script src="http://localhost:8080/socket.io/socket.io.js"></script>
	 <title>flaming-sansa</title>
	 <style type="text/css">
		html,body {
			background-color: #000;
			color: #fff;
			font-family: helvetica, arial, sans-serif;
			margin: 0;
			padding: 0;
			font-size: 12pt;
		}
		
		#canvas {
			position: absolute;
			left: 0;
			right: 0;
			top: 0;
			bottom: 0;
			margin: auto;
			border: 1px solid #555;
		}
		#chat {
			position: absolute;
			left: 0;
			right: 0;
			top: 0;
			bottom: 0;
			margin: auto;
			border: 1px solid red;
		}
		#messages {
		}
		#input {
		        display: none;
		}
	 </style>
	 
	 
	 <script type="text/javascript" src="lib/impact/impact.js"></script>
	 <script type="text/javascript" src="lib/game/main.js"></script>
</head>
<body>
	 <script type="text/javascript">
	 
	 
	 // set up sockets
	 var socket = io.connect('http://localhost:8080');

socket.on('message', function (data) {
       var player = ig.game.getEntitiesByType( EntityPlayer )[0];
	 if(player)
	 {
	 player.messagebox = player.messagebox + '\n' + data + ' disconnected';
	 }
      });

socket.on('newMsg', function (from, msg) {
       // this is where i access the newly created textfield
       
         ig.game.messages.push(from + ': ' + msg);
	 ig.game.rebuildMessageBox(ig.game);
	 ig.game.scrollMessageBox(ig.game);
       /*var player = ig.game.getEntitiesByType( EntityPlayer )[0];
	 if(player)
	 {
	 player.messagebox = player.messagebox + '\n'+ client+ ": " + msg + '';
	 }*/
      
      });

socket.on('incomingTell', function (from, msg) {
         ig.game.messages.push(from + '>> ' + msg);
	 ig.game.rebuildMessageBox(ig.game);
	 ig.game.scrollMessageBox(ig.game);
});
	 
	 
//  new player move
socket.on('moveOtherPlayer', function (xstart, ystart, direction, client) {
	 var otherplayer = ig.game.getEntitiesByType( EntityOtherplayer );
	 if(otherplayer)
	 {
		  for(var i in otherplayer)
		  {
			   if(client == otherplayer[i].name)
			   {
				    otherplayer[i].vel.x = 0;
				    otherplayer[i].vel.y = 0;
				    otherplayer[i].pos.x = xstart;
				    otherplayer[i].pos.y = ystart;
				    otherplayer[i].facing = direction;
				    otherplayer[i].netStartMove();				    
			   }
		  }
	 }
});


socket.on('updateOtherPlayer', function (client, direction) {
	 var otherplayer = ig.game.getEntitiesByType( EntityOtherplayer );
	 if(otherplayer)
	 {
		  for(var i in otherplayer)
		  {
			   if(client == otherplayer[i].name)
			   {
				    otherplayer[i].facing = direction;
				    break; // because client names are unique
			   }
		  }
	 }
});
	  
	  
// the new add player
socket.on('addPlayer', function (user, x, y, direction) {
	 var player = ig.game.getEntitiesByType( EntityPlayer )[0];
	 player.messagebox = player.messagebox + '\n' + user + ' joined.';
	 ig.game.spawnEntity( EntityOtherplayer, x, y,
	 {
		  name: user,
		  animation: 6
	 } );
	 
	 
	 /*for(var i = 0;i<players.length;i++)
	 {
		  if(player.name != players[i].name)
		  {  
			   ig.game.spawnEntity( EntityOtherplayer, x, y,
			   {
				    name:players[i].name,
				    animation:6
			   } );
		  }
	 }	*/
});

// consider merging this whole thing with playerPositions
socket.on('addAllPlayers', function (players) {
	 var localPlayer = ig.game.getEntitiesByType( EntityPlayer )[0];
	 //player.messagebox = player.messagebox + '\n' + user + ' joined.';
	 //var netplayers = ig.game.getEntitiesByType( EntityOtherplayer );
	 
	 for(i=0; i<players.length; i++)
	 {
		  if(localPlayer.name!=players[i].name)
		  {
			   ig.game.spawnEntity( EntityOtherplayer, players[i].pos.x, players[i].pos.y,
			   {
				    name: players[i].name,
				    facing: players[i].facing,
				    animation:6
			   } );
		  }
	 }
});

socket.on('dropPlayer', function (client)
{
	 var netplayers = ig.game.getEntitiesByType( EntityOtherplayer );
	 if(netplayers)
	 {
		  for(var i in netplayers)
		  {
			   // kill player entity if he exists
			   if(netplayers[i].name==client) netplayers[i].kill();
		  }
	 }
});

socket.on('playerPositions', function (players)
// updates all **currently existing**
// Otherplayer entity positions and directions
{
	 var netplayers = ig.game.getEntitiesByType( EntityOtherplayer );
	 if(netplayers)
	 {
		  for(var i in netplayers)
		  {
			   for(var j in players)
			   {
				    // if names match, update position
				    if(netplayers[i].name==players[j].name)
				    {
					     netplayers[i].pos.x = players[j].pos.x;
					     netplayers[i].pos.y = players[j].pos.y;
					     var sw = players[j].facing;
					     switch(sw)
					     {
						      case 'left':
							       netplayers[i].animation = 7;
							       break;
						      case 'right':
							       netplayers[i].animation = 8;
							       break;
						      case 'up':
							       netplayers[i].animation = 5;
							       break;
						      case 'down':
							       netplayers[i].animation = 6;
							       break;
					     };
				    }
			   }
		  }
	 }
});

	</script>
	
	
	<canvas id="canvas"></canvas>
	<div id="chat">
		  <div>
			   <textarea id="messages"></textarea>
		  </div>
		  <div>
			   <input type="text" id="input"></input>
		  </div>
	</div>
	
</body>
</html>
